<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Editor Test</title>
  <!-- 決定性修正: 引入 Firebase v9 的相容性 (compat) 函式庫，以支援 v8 語法 -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <!-- 引入 React 與 Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 引入 PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .thumbnail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .lazy-load { opacity: 0; transition: opacity 0.3s; }
    .lazy-load.visible { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      // 警告: 這是一個佔位符。請確保您的環境變數已正確設定。
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 檢查 Firebase 是否已初始化
    if (!firebase.apps.length) {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {
        console.error("Firebase 初始化失敗:", e);
      }
    }
    const storage = firebase.storage();

    const App = () => {
      const [mode, setMode] = useState('edit');
      const [pdfUrl, setPdfUrl] = useState('');
      const [thumbnails, setThumbnails] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetchThumbnails();
      }, []);

      const fetchThumbnails = async () => {
        try {
          const storageRef = storage.ref('thumbnails');
          const result = await storageRef.listAll();
          const urls = await Promise.all(result.items.map(item => item.getDownloadURL()));
          setThumbnails(urls);
        } catch (e) {
          if (e.code === 'storage/object-not-found' && e.message.includes('CORS')) {
            console.error(
              "%c災難性的 CORS 錯誤！",
              "color: red; font-size: 20px; font-weight: bold;"
            );
            console.error(
              `Firebase Storage 拒絕了來自 ${window.location.origin} 的請求。請將此來源新增至您的 Firebase Storage CORS 設定中。`
            );
            setError(`CORS 錯誤：請檢查控制台以取得解決方案。`);
          } else {
            console.error("無法取得縮圖:", e);
            setError(`無法取得縮圖: ${e.message}`);
          }
        }
      };

      const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (file) {
          setLoading(true);
          setError(null);
          try {
            const storageRef = storage.ref(`pdfs/${file.name}`);
            await storageRef.put(file);
            const url = await storageRef.getDownloadURL();
            setPdfUrl(url);
            await generateThumbnails(file);
          } catch(e) {
            console.error("上傳失敗:", e);
            setError(`上傳失敗: ${e.message}`);
          } finally {
            setLoading(false);
          }
        }
      };

      const generateThumbnails = async (file) => {
        const pdfjsLib = window['pdfjsLib'];
        if (!pdfjsLib) {
            setError("PDF.js 函式庫未載入。");
            return;
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';
        
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument(arrayBuffer);
        const pdf = await loadingTask.promise;
        const newThumbnails = [];

        for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) { // Limit to 10 for performance
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 0.2 });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          await page.render({ canvasContext: context, viewport }).promise;
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          
          const thumbRef = storage.ref(`thumbnails/thumb_${Date.now()}_${i}.png`);
          await thumbRef.put(blob);
          const thumbUrl = await thumbRef.getDownloadURL();
          newThumbnails.push(thumbUrl);
        }
        setThumbnails(prev => [...prev, ...newThumbnails]);
      };

      const LazyImage = ({ src, index }) => {
        const imgRef = useRef();
        const [isVisible, setIsVisible] = useState(false);

        useEffect(() => {
          const observer = new IntersectionObserver(
            ([entry]) => { if (entry.isIntersecting) setIsVisible(true); },
            { rootMargin: '50px' }
          );
          if (imgRef.current) observer.observe(imgRef.current);
          return () => observer.disconnect();
        }, []);

        return (
          <div ref={imgRef} className={`lazy-load ${isVisible ? 'visible' : ''} bg-gray-200 rounded`}>
            {isVisible && <img src={src} alt={`Thumbnail ${index + 1}`} className="w-full h-auto rounded" />}
          </div>
        );
      };

      return (
        <div className="container mx-auto p-4">
          <div className="flex justify-between items-center mb-4 p-4 bg-white rounded shadow">
            <input type="file" accept="application/pdf" onChange={handleFileUpload} disabled={loading} className="p-2 border rounded"/>
            <div>
              <button onClick={() => setMode('edit')} className={`mr-2 p-2 rounded ${mode === 'edit' ? 'bg-blue-500 text-white' : 'bg-gray-300'}`}>編輯模式</button>
              <button onClick={() => setMode('thumbnail')} className={`p-2 rounded ${mode === 'thumbnail' ? 'bg-blue-500 text-white' : 'bg-gray-300'}`}>縮圖模式</button>
            </div>
          </div>
          {loading && <p className="text-center">處理中...</p>}
          {error && <p className="text-center text-red-500 font-bold">{error}</p>}
          {mode === 'edit' && pdfUrl && (
            <div className="flex bg-white p-4 rounded shadow">
              <div className="w-1/4 overflow-y-auto pr-2" style={{ height: '80vh' }}>
                <div className="grid grid-cols-2 gap-2">
                  {thumbnails.map((thumb, index) => (
                    <LazyImage key={index} src={thumb} index={index} />
                  ))}
                </div>
              </div>
              <div className="w-3/4">
                <iframe src={pdfUrl} className="w-full h-full border-none" style={{ height: '80vh' }} />
              </div>
            </div>
          )}
          {mode === 'thumbnail' && (
            <div className="thumbnail-grid bg-white p-4 rounded shadow">
              {thumbnails.map((thumb, index) => (
                <div key={index} className="relative border rounded p-2">
                  <LazyImage src={thumb} index={index} />
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // 決定性修正: 使用 React 18 的 createRoot API
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);

  </script>
</body>
</html>
